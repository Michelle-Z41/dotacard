game.map={lettersStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",width:2544,height:2500,build:function(a){game.map.letters=game.map.lettersStr.split(""),game.spot=[];var b,c,d,e=$("<div>").addClass("map").css({width:game.map.width,height:game.map.height});for(c=0;c<a.height;c+=1)for(game.spot[c]=[],d=$("<div>").addClass("row").appendTo(e),b=0;b<a.width;b+=1)game.spot[c][b]=$("<div>").attr({id:game.map.toId(b,c)}).addClass("free spot").appendTo(d).on("contextmenu",game.cancelEvent);return game.map.builded=!0,e},start:function(){game.scrollX=40,game.scrollY=60,game.states.table.camera=$("<div>").appendTo(game.states.table.el).addClass("camera").mousemove(function(a){var b=game.states.table.camera.offset(),c=a.clientX-b.left,d=a.clientY-b.top;50>c?game.scrollingX=-1:c>690?game.scrollingX=1:game.scrollingX=0,50>d?game.scrollingY=-1:d>400?game.scrollingY=1:game.scrollingY=0}).hover(function(){game.scrollingX=0,game.scrollingY=0}),game.states.table.map=game.map.build({width:game.width,height:game.height}).appendTo(game.states.table.camera),setInterval(game.map.scroll,16)},scroll:function(){game.scrollingX&&(game.scrollX+=game.scrollspeed*game.scrollingX,game.scrollX<39&&(game.scrollX=39),game.scrollX>45&&(game.scrollX=45),game.states.table.map.css({transform:"rotateX(40deg) translate(-"+game.scrollX+"%, -"+game.scrollY+"%)  scale3d(0.6,0.6,0.6)"})),game.scrollingY&&(game.scrollY+=game.scrollspeed*game.scrollingY,game.scrollY<54&&(game.scrollY=54),game.scrollY>65&&(game.scrollY=65),game.states.table.map.css({transform:"rotateX(40deg) translate(-"+game.scrollX+"%, -"+game.scrollY+"%)  scale3d(0.6,0.6,0.6)"}))},toId:function(a,b){return a>=0&&b>=0&&a<game.width&&b<game.height?game.map.letters[a]+(b+1):void 0},getX:function(a){if("function"==typeof a.attr&&(a=a.attr("id")),a){var b=game.map.letters.indexOf(a[0]);if(b>=0&&b<game.width)return b}},getY:function(a){if("function"==typeof a.attr&&(a=a.attr("id")),a){var b=parseInt(a[1],10)-1;if(b>=0&&b<game.height)return b}},getSpot:function(a,b){return game.spot[b]&&game.spot[b][a]?game.spot[b][a]:void 0},getPosition:function(a){return a.hasClass("spot")?a.attr("id"):a.closest(".spot").attr("id")},mirrorPosition:function(a){var b=game.map.getX(a),c=game.map.getY(a),d=game.width-b-1,e=game.height-c-1;return game.map.toId(d,e)},rangeArray:[.5,1,1.25,1.5,2,2.5,3,3.5,4],atRange:function(a,b,c,d){if(b>=0&&b<=game.map.rangeArray.length){var e,f,g,h,i,j,k=function(a,b){var e=game.map.getSpot(a,b);e&&(d?e.hasClasses(d)||c(e):c(e))},l=game.map.getX(a),m=game.map.getY(a);if(0===b)k(l,m);else if(e=game.map.rangeArray[b],h=Math.round(e),i=e*e,j=Math.ceil(e)*Math.cos(Math.PI/4),k(l,m+h),k(l,m-h),k(l-h,m),k(l+h,m),2===b||3===b)for(f=1;j>=f;f+=1)g=Math.round(Math.sqrt(i-f*f)),k(l+f,m+g),k(l+f,m-g),k(l-f,m+g),k(l-f,m-g);else if(b>3)for(f=1;j>=f;f+=1)g=Math.round(Math.sqrt(i-f*f)),k(l+f,m+g),k(l+g,m+f),k(l+f,m-g),k(l+g,m-f),k(l-f,m+g),k(l-g,m+f),k(l-f,m-g),k(l-g,m-f)}},atCross:function(a,b,c,d,e){if(b>=0){var f,g=function(a,b){var c=game.map.getSpot(a,b);c&&(e?c.hasClasses(e)||d(c):d(c))},h=game.map.getX(a),i=game.map.getY(a);if(0===b)g(h,i);else for(f=1;b>=f;f+=1)g(h,i+f),g(h,i-f),g(h-f,i),g(h+f,i)}},atMovementRange:function(a,b,c,d){if(b>=0&&b<=game.map.rangeArray.length){var e,f,g,h,i,j,k,l,m,n,o,p=function(a,b){var e=game.map.getSpot(a,b);e&&(d?e.hasClasses(d)||c(e):c(e))},q=game.map.getPosition(a),r=game.map.getX(q),s=game.map.getY(q);if(e=game.map.rangeArray[b],h=Math.round(e),i=e*e,j=Math.ceil(e)*Math.cos(Math.PI/4),p(r,s+1),p(r,s-1),p(r-1,s),p(r+1,s),2===b||3===b)for(f=1;j>=f;f+=1)g=Math.round(Math.sqrt(i-f*f)),p(r+f,s+g),p(r+f,s-g),p(r-f,s+g),p(r-f,s-g);if(3===b&&!a.hasClass("phased"))for(k=[{a:r,b:s+2,c:r,d:s+1,e:r+1,f:s+1,g:r-1,h:s+1},{a:r,b:s-2,c:r,d:s-1,e:r+1,f:s-1,g:r-1,h:s-1},{a:r-2,b:s,c:r-1,d:s,e:r-1,f:s+1,g:r-1,h:s-1},{a:r+2,b:s,c:r+1,d:s,e:r+1,f:s+1,g:r+1,h:s-1}],l=0;l<k.length;l+=1)m=k[l],n=game.map.getSpot(m.a,m.b),o=game.map.getSpot(m.c,m.d),o&&o.hasClass("free")?(n&&n.data("detour",!1),p(m.a,m.b)):(o=game.map.getSpot(m.e,m.f),o&&o.hasClass("free")?(n&&n.data("detour",o),p(m.a,m.b)):(o=game.map.getSpot(m.g,m.h),o&&o.hasClass("free")&&(n&&n.data("detour",o),p(m.a,m.b))))}},inRange:function(a,b,c){game.map.atRange(a,0,c),game.map.around(a,b,c)},around:function(a,b,c){game.map.atRange(a,b,c),3===b&&game.map.atRange(a,1,c),4===b&&game.map.atRange(a,2,c),5===b&&(game.map.atRange(a,1,c),game.map.atRange(a,3,c))},radialStroke:function(a,b,c){var d,e,f,g,h,i,j=function(a,b,d){var e=game.map.getSpot(a,b);e&&e.addClass(c+" stroke "+d)},k=game.map.getX(a),l=game.map.getY(a);if(0===b)return j(k,l,"left right top bottom");if(d=game.map.rangeArray[b],g=Math.round(d),h=d*d,i=Math.ceil(d)*Math.cos(Math.PI/4),b%2===0?(j(k,l+g,"bottom"),j(k,l-g,"top"),j(k-g,l,"left"),j(k+g,l,"right")):b%2===1&&(j(k,l+g,"bottom left right"),j(k,l-g,"top  left right"),j(k-g,l,"left top bottom"),j(k+g,l,"right top bottom")),2===b||3===b)for(e=1;i>=e;e+=1)f=1,j(k+e,l+f,"right bottom"),j(k+e,l-f,"right top"),j(k-e,l+f,"left bottom"),j(k-e,l-f,"left top");else if(4===b||6===b||8===b)for(e=1;i>=e;e+=1)f=Math.round(Math.sqrt(h-e*e)),j(k+e,l+f,"right bottom"),j(k+f,l+e,"right bottom"),j(k+e,l-f,"right top"),j(k+f,l-e,"right top"),j(k-e,l+f,"left bottom"),j(k-f,l+e,"left bottom"),j(k-e,l-f,"left top"),j(k-f,l-e,"left top");else if(b>=5)for(e=1;i>=e;e+=1)f=Math.round(Math.sqrt(h-e*e)),j(k+e,l+f,"bottom"),j(k-e,l+f,"bottom"),j(k+e,l-f,"top"),j(k-e,l-f,"top"),j(k-f,l+e,"left"),j(k-f,l-e,"left"),j(k+f,l-e,"right"),j(k+f,l+e,"right");7===b&&(j(k+3,l+2,"bottom"),j(k-3,l+2,"bottom"),j(k+3,l-2,"top"),j(k-3,l-2,"top"),j(k-2,l+3,"left"),j(k-2,l-3,"left"),j(k+2,l+3,"right"),j(k+2,l-3,"right"))},crossStroke:function(a,b,c,d){var e,f=function(a,b,c){var e=game.map.getSpot(a,b);e&&e.addClass(d+" stroke "+c)},g=game.map.getX(a),h=game.map.getY(a);if(0===b)return f(g,h,"left right top bottom");for(f(g,h+b,"bottom"),f(g,h-b,"top"),f(g-b,h,"left"),f(g+b,h,"right"),e=1;b>=e;e+=1)f(g-c,h+e,"left"),f(g+c,h+e,"right");for(e=1;b>=e;e+=1)f(g-c,h-e,"left"),f(g+c,h-e,"right");for(e=1;b>=e;e+=1)f(g+e,h-c,"top"),f(g+e,h+c,"bottom");for(e=1;b>=e;e+=1)f(g-e,h-c,"top"),f(g-e,h-c,"bottom")},linearStroke:function(a,b,c,d){var e,f=function(a,b,c){var e=game.map.getSpot(a,b);e&&e.addClass(d+" stroke "+c)},g=game.map.getX(a),h=game.map.getY(a),i=game.map.getX(game.castpos),j=game.map.getY(game.castpos);if(h-j>0)for(f(i,j+b,"bottom"),e=1;b>=e;e+=1)f(i-c,j+e,"left"),f(i+c,j+e,"right");if(0>h-j)for(f(i,j-b,"top"),e=1;b>=e;e+=1)f(i-c,j-e,"left"),f(i+c,j-e,"right");if(g-i>0)for(f(i+b,j,"right"),e=1;b>=e;e+=1)f(i+e,j-c,"top"),f(i+e,j+c,"bottom");if(0>g-i)for(f(i-b,j,"left"),e=1;b>=e;e+=1)f(i-e,j-c,"top"),f(i-e,j-c,"bottom")},getRange:function(a){var b=a;return a===game.data.ui.ortho&&(b=1),a===game.data.ui.melee&&(b=2),a===game.data.ui["short"]&&(b=3),a===game.data.ui.ranged&&(b=4),a===game.data.ui["long"]&&(b=5),b},highlight:function(){game.selectedCard&&(game.selectedCard.hasClasses("hero unit")?(game.selectedCard.strokeAttack(),"turn"===game.status&&(game.tutorial.lessonAttack||game.selectedCard.highlightMove(),game.tutorial.lessonSkill||game.selectedCard.highlightAttack())):game.selectedCard.hasClass("skill")?(game.selectedCard.highlightSource(),game.selectedCard.strokeSkill(),"turn"===game.status&&game.selectedCard.highlightTargets()):game.selectedCard.hasClass("tower")&&game.selectedCard.strokeAttack())},unhighlight:function(){$(".map .card").off("contextmenu taphold mouseenter mouseleave").removeClass("attacktarget source casttarget targetarea"),$(".map .spot").off("contextmenu taphold mouseenter mouseleave").removeClass("movearea targetarea stroke playerattack enemyattack skillcast skillarea top bottom left right")},clear:function(){game.map.unhighlight(),$(".map .spot").removeClass("block")}};