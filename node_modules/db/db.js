var fs = require('fs');

var readData = function(cb){
  fs.readFile(__dirname+'/database.csv', function (err, data) {    
    if(err) throw err;    
    cb(data);
  });
};

var writeData = function(data){
  var lines = [];
  for(var i = 0; i < data.length; i++){
    var line = data[i];
    if(line[0]) lines.push(line[0] + ';'+ line[1]);
  }
  var wdata = lines.join('\n');
  fs.writeFile(__dirname+'/database.csv', wdata, function(err){    
    if(err) throw err;
  });  
};


var parseData = function(data, cb){
  var lines = (''+data).split('\n');
  for(var i = 0; i < lines.length; i++){
    var line = lines[i].split(';'),
        name = line[0],
        val = line[1] || '';
    var r = cb(name, val);
    if(r == 'break') break;
  }  
};

exports.get = function(name, cb){
  readData(function(data){
    parseData(data, function(n, v){
      if(name == n){        
        cb(v);
        return 'break';
      }  
    });
    cb('');
    console.log('Read: '+name);
  });
};

exports.set = function(name, val){
  var database = [[name, val || '']];
  readData(function(data){
    parseData(data, function(n, v){ 
      if(name != n) database.push([n, v]);
    });
    writeData(database);
    console.log('Write: '+name);
  });  
  return true;
};